# Strategy System Refactor - OpenClaw Authentication

**Date:** 2026-02-16  
**Branch:** dev  
**Commit:** 995103a  
**Builder:** Builder-A (subagent)

## Problem

The strategy_designer.py and strategy_tuner.py files were attempting to call Claude models using:
1. Direct Anthropic Python SDK calls
2. External API key management (env vars, .env files, manual key extraction)
3. This approach was fragile, required separate authentication, and duplicated Rob's existing OpenClaw setup

## Solution

Refactored `orchestration/llm_client.py` to use OpenClaw's built-in agent calling system:

### Before (BROKEN):
```python
# Old approach - managing API keys separately
import anthropic
api_key = _get_api_key()  # Complex key extraction logic
client = anthropic.Anthropic(api_key=api_key)
response = client.messages.create(...)
```

### After (CORRECT):
```python
# New approach - use OpenClaw's authentication
subprocess.run([
    'openclaw', 'agent',
    '--session-id', f'llm-call-{model}',
    '--message', prompt,
    '--json'
], ...)
# Parse response.result.payloads[0].text
```

## Key Changes

1. **orchestration/llm_client.py**
   - Replaced Anthropic SDK with `openclaw agent` CLI calls
   - Uses subprocess to call the OpenClaw agent system
   - Proper JSON response parsing to extract text from OpenClaw's response structure
   - Model routing via session IDs (e.g., `llm-call-opus`, `llm-call-sonnet`)

2. **Authentication**
   - Now uses Rob's pre-configured OpenClaw authentication (~/.openclaw/)
   - No separate API key management needed
   - Same auth system that powers Jarvis chat sessions

3. **Verification**
   - Created test_strategy_generation.py to validate the system
   - Successfully generated strategy_023.py (Volatility Expansion Volume Breakout)
   - Strategy compiles and follows template structure
   - 4503 bytes of valid Python code generated by Opus

## How It Works Now

### Strategy Designer (Opus)
```python
from orchestration.llm_client import call_llm
output = call_llm(prompt, model='opus', max_tokens=4096)
# This internally calls: openclaw agent --message "..." --json
```

### Strategy Tuner (Sonnet)
```python
from orchestration.llm_client import call_llm
output = call_llm(prompt, model='sonnet', max_tokens=4096)
# Same mechanism, different model routing
```

### Model Routing
- `opus` → claude-opus-4
- `sonnet` → claude-sonnet-4
- `haiku` → claude-haiku-4
- `mini` → gpt-5.1-codex-mini
- `codex` → gpt-5.3-codex

## Testing

### Test Script
```bash
cd /home/rob/.openclaw/workspace/blofin-stack
python3 test_strategy_generation.py
```

### Expected Output
```
✓ SUCCESS! Strategy generated successfully!
  Strategy Name: volatility_expansion_volume_breakout
  Strategy Number: 23
  File Path: /home/rob/.openclaw/workspace/blofin-stack/strategies/strategy_023.py
  Code Length: 4503 characters
```

### Verification
- ✓ Strategy generation works (Opus)
- ✓ JSON response parsing works
- ✓ Code extraction and validation works
- ✓ File saving and registration works
- ✓ Uses OpenClaw authentication (no API key errors)

## Benefits

1. **Single Authentication Source**: Uses the same auth Rob uses to chat with Jarvis
2. **No Key Management**: No more juggling API keys, .env files, or environment variables
3. **Consistent Routing**: Model calls go through OpenClaw's routing system
4. **Better Debugging**: JSON responses include metadata (usage, timing, model info)
5. **Future-Proof**: If Rob changes auth or adds new providers, it works automatically

## Next Steps

1. Test strategy_tuner.py with a real underperforming strategy
2. Verify the tuning suggestions work correctly
3. Consider adding retry logic for transient failures
4. Monitor token usage via OpenClaw's built-in tracking

## Files Changed

- `orchestration/llm_client.py` - Complete rewrite (54 lines → 106 lines)
- `strategies/strategy_023.py` - Generated strategy (proof of concept)
- `test_strategy_generation.py` - Validation test script

## Status

✅ **COMPLETE** - Strategy generation now uses OpenClaw authentication.  
✅ **TESTED** - Successfully generated a working strategy via Opus.  
✅ **COMMITTED** - Changes pushed to dev branch (commit 995103a).

---

*This refactor eliminates external API key dependencies and aligns the strategy system with OpenClaw's built-in authentication and model routing.*
